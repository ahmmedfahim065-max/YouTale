<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YouTale - Welcome</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(-45deg, #4f46e5, #7c3aed, #db2777, #2563eb);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            user-select: none;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .glass-card { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(20px); 
            border-radius: 2.5rem; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .brand-text {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(to right, #4f46e5, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .input-box {
            background: rgba(243, 244, 246, 0.8);
            border: 2px solid transparent;
            transition: 0.3s;
        }
        .input-box:focus {
            background: #fff;
            border-color: #7c3aed;
            box-shadow: 0 0 15px rgba(124, 58, 237, 0.2);
        }
        .tab-btn.active { 
            color: #4f46e5 !important; 
            border-bottom: 3px solid #4f46e5;
        }
        /* Loader for Auto-login */
        #page-loader {
            position: fixed; inset: 0; background: white; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="p-4">

    <!-- Auto-Login Loader Overlay -->
    <div id="page-loader">
        <h1 class="text-4xl font-extrabold brand-text mb-4">YouTale</h1>
        <div class="w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
    </div>

    <div class="glass-card w-full max-w-md p-8 md:p-10 relative overflow-hidden">
        
        <!-- Guest Mode Button (Now at the top) -->
        <button onclick="continueAsGuest()" class="w-full bg-indigo-600 text-white rounded-2xl py-3 font-bold shadow-lg hover:bg-indigo-700 active:scale-95 text-sm transition-all mb-8">
            üïµÔ∏è‚Äç‚ôÇÔ∏è Read without an account
        </button>

        <div class="text-center mb-8 relative z-10">
            <h2 class="text-5xl font-extrabold brand-text tracking-tighter mb-2">YouTale</h2>
            <p class="text-gray-500 text-sm font-semibold">Read, Write, and Earn</p>
        </div>

        <!-- Tab Switching -->
        <div class="flex border-b border-gray-100 mb-8 relative z-10">
            <button onclick="switchTab('login')" id="tab-login" class="flex-1 py-3 text-center font-bold text-gray-400 active">Login</button>
            <button onclick="switchTab('register')" id="tab-register" class="flex-1 py-3 text-center font-bold text-gray-400">Register</button>
        </div>

        <!-- Login Form -->
        <div id="form-login" class="space-y-4 relative z-10">
            <div class="relative">
                <span class="absolute inset-y-0 left-4 flex items-center text-gray-400">üìß</span>
                <input type="email" id="login-email" class="input-box w-full rounded-2xl py-4 pl-12 pr-5 outline-none" placeholder="Your Email ID">
            </div>
            <div class="relative">
                <span class="absolute inset-y-0 left-4 flex items-center text-gray-400">üîë</span>
                <input type="password" id="login-password" class="input-box w-full rounded-2xl py-4 pl-12 pr-5 outline-none" placeholder="Password">
            </div>
            
            <div class="text-right px-1">
                <button onclick="forgotPassword()" class="text-xs font-bold text-indigo-600 hover:text-pink-600 transition-colors">Forgot Password?</button>
            </div>

            <button onclick="processLogin()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl py-4 font-bold shadow-xl active:scale-95 transition-all">
                Sign In
            </button>
        </div>

        <!-- Register Form -->
        <div id="form-register" class="space-y-4 hidden relative z-10">
            <input type="text" id="reg-name" class="input-box w-full rounded-2xl py-4 px-5 outline-none" placeholder="Your Full Name">
            <input type="email" id="reg-email" class="input-box w-full rounded-2xl py-4 px-5 outline-none" placeholder="Email ID">
            <input type="password" id="reg-password" class="input-box w-full rounded-2xl py-4 px-5 outline-none" placeholder="Password (6+ chars)">
            <button onclick="processRegister()" class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-2xl py-4 font-bold shadow-xl active:scale-95 transition-all">
                Create Account
            </button>
        </div>

        <div id="auth-message" class="mt-4 text-center text-xs font-bold p-3 rounded-xl hidden"></div>

        <div class="relative flex items-center my-8">
            <div class="flex-grow border-t border-gray-200"></div>
            <span class="flex-shrink-0 mx-4 text-gray-400 text-[10px] font-bold uppercase tracking-widest">OR</span>
            <div class="flex-grow border-t border-gray-200"></div>
        </div>

        <!-- Google Button -->
        <button onclick="loginWithGoogle()" class="w-full bg-white text-gray-700 border-2 border-gray-100 rounded-2xl py-4 font-bold flex items-center justify-center gap-3 hover:bg-gray-50 active:scale-95 transition-all">
            <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" class="w-6 h-6" alt="Google">
            Sign in with Google
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9WjFq4Ips9wMKoDmO8v2M6aZ2OxynQQo",
            authDomain: "youtale-f6845.firebaseapp.com",
            projectId: "youtale-f6845",
            storageBucket: "youtale-f6845.firebasestorage.app",
            messagingSenderId: "10854951568",
            appId: "1:10854951568:web:cffcc9813d858e130d8615"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();
        const appId = "YouTale-V10-Final";

        // --- Persistent Login Check ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is already logged in, skip login page
                window.location.href = "dashboard.html"; 
            } else {
                // No user found, show login UI
                document.getElementById('page-loader').style.display = 'none';
            }
        });

        window.switchTab = (tab) => {
            const isLogin = tab === 'login';
            document.getElementById('form-login').classList.toggle('hidden', !isLogin);
            document.getElementById('form-register').classList.toggle('hidden', isLogin);
            document.getElementById('tab-login').classList.add(isLogin ? 'active' : 'inactive');
            document.getElementById('tab-login').classList.remove(!isLogin ? 'active' : 'inactive');
            document.getElementById('tab-register').classList.add(!isLogin ? 'active' : 'inactive');
            document.getElementById('tab-register').classList.remove(isLogin ? 'active' : 'inactive');
            document.getElementById('auth-message').classList.add('hidden');
        };

        window.processLogin = async () => {
            const e = document.getElementById('login-email').value, p = document.getElementById('login-password').value;
            if(!e || !p) return showMsg('Please fill all fields!', true);
            try {
                showMsg('Signing in...', false);
                await signInWithEmailAndPassword(auth, e, p);
                window.location.href = "dashboard.html";
            } catch(err) { showMsg('Invalid email or password!', true); }
        };

        window.processRegister = async () => {
            const n = document.getElementById('reg-name').value, e = document.getElementById('reg-email').value, p = document.getElementById('reg-password').value;
            if(!n || !e || p.length < 6) return showMsg('Password must be 6+ characters!', true);
            try {
                showMsg('Creating account...', false);
                const cred = await createUserWithEmailAndPassword(auth, e, p);
                await updateProfile(cred.user, { displayName: n });
                await setDoc(doc(db, 'artifacts', appId, 'users', cred.user.uid, 'profile'), {
                    name: n, email: e, role: 'user', earnings: 0, joinedAt: new Date().toISOString()
                });
                window.location.href = "dashboard.html";
            } catch(err) { showMsg('Email already in use!', true); }
        };

        window.forgotPassword = async () => {
            const email = document.getElementById('login-email').value;
            if(!email) return showMsg('Enter your email first!', true);
            try {
                await sendPasswordResetEmail(auth, email);
                showMsg('Reset link sent to your email.', false);
            } catch(err) { showMsg('Failed to send link.', true); }
        };

        window.loginWithGoogle = async () => {
            try {
                const res = await signInWithPopup(auth, googleProvider);
                const user = res.user;
                const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile');
                const docSnap = await getDoc(userRef);
                if (!docSnap.exists()) {
                    await setDoc(userRef, { name: user.displayName, email: user.email, role: 'user', earnings: 0, joinedAt: new Date().toISOString() });
                }
                window.location.href = "dashboard.html";
            } catch(err) { showMsg('Google login failed.', true); }
        };

        window.continueAsGuest = () => { localStorage.setItem('youtale_guest', 'true'); window.location.href = "dashboard.html"; };

        function showMsg(m, isE) {
            const box = document.getElementById('auth-message');
            box.innerText = m; box.className = `mt-4 text-center text-xs font-bold p-3 rounded-xl ${isE ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-700'}`;
            box.classList.remove('hidden');
        }
    </script>
</body>
</html>
